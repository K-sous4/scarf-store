#!/usr/bin/env bash
# dev.sh â€” starts the full development stack
# Usage: ./dev.sh
#
# What it does:
#   1. Starts postgres + redis via Docker (infra only)
#   2. Activates backend venv and runs uvicorn --reload
#   3. Runs npm run dev for the frontend
#   4. Ctrl+C stops everything cleanly

set -euo pipefail

# â”€â”€ colours â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GREEN='\033[0;32m'; YELLOW='\033[1;33m'; CYAN='\033[0;36m'
RED='\033[0;31m'; BOLD='\033[1m'; NC='\033[0m'

info()    { echo -e "${CYAN}â–¸ $*${NC}"; }
success() { echo -e "${GREEN}âœ“ $*${NC}"; }
warn()    { echo -e "${YELLOW}âš  $*${NC}"; }
error()   { echo -e "${RED}âœ— $*${NC}" >&2; }

# â”€â”€ paths â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND="$ROOT/backend"
FRONTEND="$ROOT/frontend"
VENV="$BACKEND/venv"
ENV_FILE="$ROOT/.env"
LOG_DIR="$ROOT/.dev-logs"
mkdir -p "$LOG_DIR"

# â”€â”€ pids of background processes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PIDS=()

cleanup() {
  echo -e "\n${YELLOW}Stopping dev servers...${NC}"
  for pid in "${PIDS[@]:-}"; do
    kill "$pid" 2>/dev/null || true
  done
  success "All dev processes stopped."
  exit 0
}
trap cleanup SIGINT SIGTERM

# â”€â”€ checks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ! command -v docker &>/dev/null; then
  error "docker not found. Please install Docker."
  exit 1
fi

if [[ ! -d "$VENV" ]]; then
  warn "No venv found at $VENV. Creating one..."
  python3 -m venv "$VENV"
  success "Venv created."
  info "Installing backend dependencies..."
  source "$VENV/bin/activate"
  pip install --quiet -r "$BACKEND/requirements.txt"
  success "Backend dependencies installed."
fi

if [[ ! -d "$FRONTEND/node_modules" ]]; then
  info "node_modules not found â€” running npm install..."
  cd "$FRONTEND" && npm install --silent
  success "Frontend dependencies installed."
fi

# â”€â”€ load env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [[ -f "$ENV_FILE" ]]; then
  # Export only non-comment, non-empty lines
  set -a
  # shellcheck disable=SC1090
  source <(grep -v '^\s*#' "$ENV_FILE" | grep -v '^\s*$')
  set +a
fi

# â”€â”€ 1. start infra â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "Starting database and cache..."
docker compose -f "$ROOT/docker-compose.yml" up -d postgres redis

# â”€â”€ 2. wait for postgres â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "Waiting for postgres to be ready..."
MAX_WAIT=30; elapsed=0
until docker compose -f "$ROOT/docker-compose.yml" exec -T postgres \
      pg_isready -U scarf_user -d scarf_store_db &>/dev/null; do
  sleep 1
  elapsed=$((elapsed + 1))
  if [[ $elapsed -ge $MAX_WAIT ]]; then
    error "Postgres did not become ready after ${MAX_WAIT}s."
    exit 1
  fi
done
success "Postgres ready."

# â”€â”€ 3. start backend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "Starting backend (uvicorn --reload)..."
source "$VENV/bin/activate"
cd "$BACKEND"
uvicorn main:app \
  --host "${API_HOST:-0.0.0.0}" \
  --port "${API_PORT:-8000}" \
  --reload \
  > "$LOG_DIR/backend.log" 2>&1 &
PIDS+=($!)
success "Backend â†’ http://localhost:${API_PORT:-8000}  (logs: .dev-logs/backend.log)"

# â”€â”€ 4. start frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
info "Starting frontend (npm run dev)..."
cd "$FRONTEND"
npm run dev \
  > "$LOG_DIR/frontend.log" 2>&1 &
PIDS+=($!)
success "Frontend â†’ http://localhost:3000  (logs: .dev-logs/frontend.log)"

# â”€â”€ summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo ""
echo -e "${BOLD}Dev stack running:${NC}"
echo -e "  ðŸ–¥  Frontend  â†’ ${CYAN}http://localhost:3000${NC}"
echo -e "  âš™  Backend   â†’ ${CYAN}http://localhost:${API_PORT:-8000}${NC}"
echo -e "  ðŸ“– API Docs  â†’ ${CYAN}http://localhost:${API_PORT:-8000}/docs${NC}"
echo -e "  ðŸ—„  Postgres  â†’ ${CYAN}localhost:5432${NC}"
echo -e "  ðŸ”´ Redis     â†’ ${CYAN}localhost:6379${NC}"
echo ""
echo -e "${YELLOW}Logs: .dev-logs/backend.log | .dev-logs/frontend.log${NC}"
echo -e "${YELLOW}Press Ctrl+C to stop all services.${NC}"
echo ""

# keep script alive, tail logs to stdout
tail -f "$LOG_DIR/backend.log" "$LOG_DIR/frontend.log" &
PIDS+=($!)
wait
